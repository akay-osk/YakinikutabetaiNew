<!DOCTYPE html>
<html lang="ja">

<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>MEAT UP! - チャットルーム</title>
	<link rel="stylesheet" href="/css/Chatroom.css" />
</head>

<body>
	<header>
		<h1>チャットルーム</h1>
		<button id="exit">退出</button>
	</header>

	<main>
		<div id="chat"></div>

		<button id="reload">再読み込み</button>
		<div class="input-area">
			<input type="text" id="comment" placeholder="メッセージを入力" />
			<button id="send">送信</button>
	</main>

	<script>
		const chatBox = document.getElementById("chat");
		const commentInput = document.getElementById("comment");
		const sendButton = document.getElementById("send");
		const reloadButton = document.getElementById("reload");
		const exitButton = document.getElementById("exit");

		// チャット履歴を取得
		async function fetchChatHistory() {
			try {
				const res = await fetch('/chatroom/history');
				if (!res.ok) throw new Error('履歴取得失敗');
				const messages = await res.json();
				displayMessages(messages);
			} catch (err) {
				console.error("履歴取得エラー:", err);
				chatBox.innerHTML = "<p>チャット履歴の取得に失敗しました。</p>";
			}
		}

		// チャット履歴を表示
		function displayMessages(messages) {
			chat.innerHTML = ''; // 古いメッセージをクリア
			messages.forEach(message => {
				const messageElement = document.createElement('div');
				const isSelf = message.user_name === userName;

				messageElement.classList.add('message');
				messageElement.classList.add(isSelf ? 'self' : 'other');

				messageElement.innerHTML = `
	      <div class="message-info">${message.user_name} [${message.created_at}]</div>
	      <div>${message.chat_comment}</div>
	    `;

				chat.appendChild(messageElement);
			});

			chat.scrollTop = chat.scrollHeight;
		}


		// メッセージ送信
		sendButton.addEventListener("click", async () => {
			const comment = commentInput.value.trim();
			if (!comment) return;

			try {
				const res = await fetch('/chatroom/insert', {
					method: 'POST',
					headers: {'Content-Type': 'application/json'},
					body: JSON.stringify({chat_comment: comment})
				});

				if (!res.ok) throw new Error("送信失敗");
				commentInput.value = '';
				await fetchChatHistory(); // 送信後に履歴再読み込み
			} catch (err) {
				console.error("送信エラー:", err);
				alert("メッセージの送信に失敗しました。");
			}
		});

		// 再読み込み
		reloadButton.addEventListener("click", fetchChatHistory);

		// 退出処理
		exitButton.addEventListener("click", async () => {
			if (!confirm("本当に退出しますか？")) return;

			try {
				const res = await fetch('/chatroom/exit', {method: 'POST'});
				if (!res.ok) throw new Error("退出失敗");
				window.location.href = "/home"; // homeに遷移
			} catch (err) {
				console.error("退出エラー:", err);
				alert("退出に失敗しました。");
			}
		});

		// 初回読み込み
		window.addEventListener("DOMContentLoaded", fetchChatHistory);
	</script>
</body>

</html>