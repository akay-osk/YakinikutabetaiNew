<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>MatchingSucceeded</title>
</head>
<body>
	<h1>マッチング成立画面</h1>
	
	<form action="/matching/join" method="post">
	    <div class="tag-candidates">

	        <div class="tag-option-row" th:each="tag, iterStat : ${tagList}" th:if="${iterStat.index} < 3">
				<span class="tag-text">参加中のユーザー</span>

	            <div class="tag-icons">
					<div th:each="user, stat : ${tag.users}" th:if="${stat.index} < 3" class="user-icon-wrapper">
	                <img th:src="@{${user.user_icon}}" class="user-icon" th:alt="${user.user_name}"
	                     data-user-id="[[${user.id}]]">

	                <div class="popup-profile" th:id="'popup-profile-' + ${user.id}">
	                    <!-- Ajaxで補完される領域 -->
	                </div>
	            </div>
	        </div>

	    </div>
	    </div>
	    <button type="submit" class="join-button">参加する</button>
	</form>
	
	
	<script>
		document.addEventListener("DOMContentLoaded", () => {
		    document.querySelectorAll('.user-icon-wrapper').forEach(wrapper => {
		        const icon = wrapper.querySelector('.user-icon');
		        const popup = wrapper.querySelector('.popup-profile');
		        const userId = icon.getAttribute("data-user-id");

		        let fetched = false;

		        icon.addEventListener('mouseenter', () => {
		            if (!fetched) {
		                fetch(`/user/detail/${userId}`)
		                    .then(response => response.json())
		                    .then(data => {
		                        popup.innerHTML = `
		                            <strong>${data.userName}</strong><br>
		                            年齢：${data.userAge}歳<br>
		                            性別：${data.gender}<br>
		                            好きな部位：${data.likes}<br>
		                            詳細：${data.detail}<br>
		                            タグ：${data.tags.map(tag => `<span class="tag">#${tag}</span>`).join(' ')}
		                        `;
		                        fetched = true;
		                        popup.style.display = 'block';
		                    });
		            } else {
		                popup.style.display = 'block';
		            }
		        });

		        wrapper.addEventListener('mouseleave', () => {
		            popup.style.display = 'none';
		        });
		    });
		});

	</script>

</body>
</html>